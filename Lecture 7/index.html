<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content=
      "width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Computational Physics Lecture 7</title>
    <link rel="stylesheet" href="../dist/reset.css">
    <link rel="stylesheet" href="../dist/reveal.css">
    <link rel="stylesheet" href="../dist/theme/serif.css"
      id="theme">
    <!-- <link rel="stylesheet" href="./dist/theme/night.css" id="theme"> -->
    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href=
      "../plugin/highlight/monokai.css" id="highlight-theme">
    <link rel="stylesheet" href=
      "../css/style.css">
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <h2>Review</h2>
          <div class="fragment">
            <p>Last time we talked about:</p>
            <ul>
              <li>Euler's method
                $$
                \begin{align}
                k_1 &= f(x_n, y_n) \\
                y_{n+1} &= y_n + h k_1
                \end{align}
                $$
              </li>
              <li class="fragment">Midpoint method
                $$
                \begin{align}
                k_1 &= f(x_n, y_n) \\
                k_2 &= f\left(x_n + \frac{h}{2}, y_n + \frac{h}{2}k_1\right) \\
                y_{n+1} &= y_n + h k_2
                \end{align}
                $$
              </li>
            </ul>
        </section>

        <section>
          <h2>Review</h2>
          <ul>
            <li>4th-order Runge-Kutta (RK4)
              $$
              \begin{align}
              k_1 &= f(x_n, y_n) \\
              k_2 &= f\left(x_n + \frac{h}{2}, y_n + \frac{h}{2}k_1\right) \\
              k_3 &= f\left(x_n + \frac{h}{2}, y_n + \frac{h}{2}k_2\right) \\
              k_4 &= f(x_n + h, y_n + hk_3) \\
              y_{n+1} &= y_n + \frac{h}{6}(k_1 + 2k_2 + 2k_3 + k_4)
              \end{align}
              $$
            </li>
          </ul>
        </section>

        <section>
          <h2>Runge-Kutta Methods</h2>
          <p>All Runge-Kutta methods can be summarized in the following way:</p>
          $$
          y_{n+1} = y_n + h\sum_{i = 1}^{s}b_i k_i
          $$
          <div class="fragment">
            <p>where:</p>
            $$
            k_i = f\left(x_n + c_i h, y_n + h \sum_{j=1}^{i-1}a_{ij}k_j\right),\quad i = 1, 2, \ldots, s
            $$
            <p>where $s$ is the number of "stages" in the method. The method is
              completely specified by the coefficients $a_{ij}$, $b_i$, and $c_i$.</p>
          </div>
          <p class="fragment">How many parameters in total?</p>
        </section>

        <section>
          <h2>Runge-Kutta Methods</h2>
          <p>It's customary to list the coefficients in the Butcher tableau:</p>
          $$
          \begin{array}{c|cccccs}
          c_1 & & & & & & \\
          c_2 & a_{21} &  &  & & & \\
          c_3 & a_{31} & a_{32} &  & & &  \\
          c_4 & a_{41} & a_{42} & a_{43} & & &  \\
          \vdots & \vdots & \vdots & \vdots & \ddots & &  \\
          c_s & a_{s1} & a_{s2} & a_{s3} & \cdots & a_{s,s-1} &  \\
          \hline
          & b_1 & b_2 & b_3 & \cdots & b_{s-1} & b_s
          \end{array}
          $$
        </section>

        <section>
          <h2>Runge-Kutta Methods</h2>
          <p>How to determine the coefficients?</p>
          <p class="fragment">
            We need to match the Taylor expansion of $y(x_n + h)$ to the Runge-Kutta
            formula to a desired order. The Taylor expansion is:
            $$
            y(x_n + h) = y(x_n) + hy'(x_n) + \frac{h^2}{2}y''(x_n) + \frac{h^3}{6}y^{(3)}(x_n) + \frac{h^4}{24}y^{(4)}(x_n) + \ldots
            $$
          </p>
        </section>

        <section>
          <h2>Runge-Kutta Methods</h2>
          <p>Using the chain rule on the ODE $y' = f(x, y)$, we can express the higher order derivatives using partial derivatives of $f$:</p>
          $$
          \begin{align}
          y' &= f \\
          y'' &= f_x + f_y f \\
          y^{(3)} &= f_{xx} + 2f f_{xy} + f f_y^2 + f_x f_y + f^2 f_{yy} \\
          y^{(4)} &= f_{xxx} + 3f f_{xxy} + 3f^2 f_{xyy} + f^3 f_{yyy} + 3f_x f_{xy} + 5f f_y f_{xy} \\
          &\quad + 3f f_x f_{yy} + f_{xx}f_y + f_x f_y^2 + f f_y^3 + 4 f^2 f_y f_{yy} \\
          \dots
          \end{align}
          $$
        </section>

        <section>
          <h2>Runge-Kutta Methods</h2>
          <p>For example, lets plug in a 2nd order Runge-Kutta method with 2 stages:</p>
          $$
          \begin{align}
            k_1 &= f(x_n + c_1 h, y_n) \\
                &\approx f + c_1 h f_x \\
            k_2 &= f\left(x_n + c_2 h, y_n + h a_{21} k_1\right) \\
                &\approx f + c_2 h f_x + a_{21} h k_1 f_y \\
                &\approx f + c_2 h f_x + a_{21} h f f_y
          \end{align}
          $$</p>
          <p class="fragment">Then, the Runge-Kutta formula gives:
            $$
            y_{n+1} = y_n + h(b_1 k_1 + b_2 k_2) = y_n + h(b_1 + b_2)f + h^2(b_1 c_1 + b_2 c_2)f_x + h^2 b_2 a_{21} f f_y
            $$
          </p>
          <p class="fragment">We need to match with the Taylor expansion:
            $$
            y(x_n + h) = y(x_n) + hy'(x_n) + \frac{h^2}{2}y''(x_n) + \ldots = y_n + h f + \frac{h^2}{2}(f_x + f f_y) + \ldots
            $$
          </p>
        </section>

        <section>
          <h2>Runge-Kutta Methods</h2>
          <p>The matching equations become:
          $$
          \begin{align}
          b_1 + b_2 &= 1 \\
          b_1 c_1 + b_2 c_2 &= \frac{1}{2} \\
          b_2 a_{21} &= \frac{1}{2}
          \end{align}
          $$</p>
          <p class="fragment">There are 5 unknowns and 3 equations, so we can
            choose 2 of them arbitrarily. For example, if we choose $c_1 = 0$ and
            $b_2 = 1$, then we get the midpoint method:
            $$
            \begin{array}{c|cc}
            0 & & \\
            1/2 & 1/2 & \\
            \hline
            & 0 & 1
            \end{array}
          $$</p>
        </section>

        <section>
          <h2>Butcher Tableau for RK4</h2>
          $$
          \begin{array}{c|cccc}
          0 &  &  &  & \\
          1/2 & 1/2 &  &  &  \\
          1/2 & 0 & 1/2 &  &  \\
          1   & 0 & 0 & 1 &  \\
          \hline
          & 1/6 & 1/3 & 1/3 & 1/6
          \end{array}
          $$
          <p class="fragment">It turns out that for any order higher than 4,
          more than 4 stages are needed, or equivalently more than 4 intermediate
          $k_i$'s are needed. This makes RK4 a sweet spot for accuracy vs
          efficiency.</p>
        </section>

        <section>
          <h2>Butcher Tableau for 5th Order Runge-Kutta</h2>
          <p>Here's a 5th order Runge-Kutta method by Dormand-Prince, one of the
          many possible 5th order methods:</p>
          <div style="font-size: smaller;">
          $$
          \begin{array}{c|ccccccc}
          0 &  &  &  &  &  &  & \\
          1/5 & 1/5 &  &  &  &  &  & \\
          3/10 & 3/40 & 9/40 &  &  &  &  & \\
          4/5 & 44/45 & -56/15 & 32/9 &  &  &  & \\
          8/9 & 19372/6561 & -25360/2187 & 64448/6561 & -212/729 &  &  & \\
          1 & 9017/3168 & -355/33 & 46732/5247 & 49/176 & -5103/18656 &  & \\
          1 & 35/384 & 0 & 500/1113 & 125/192 & -2187/6784 & 11/84 & \\
          \hline
          & 35/384 & 0 & 500/1113 & 125/192 & -2187/6784 & 11/84 & 0
          \end{array}
          $$
          </div>
          <div class="fragment">
          <p>How many evaluations of $f$?</p>
          </div>
        </section>

        <section>
          <h2>Stiff Problems and Stability</h2>
        </section>

        <section>
          <h2>Stiff Problems</h2>
          <p>Consider the following set of equations:</p>
          $$
          \begin{align}
          \frac{du}{dx} &= 998u + 1998v \\
          \frac{dv}{dx} &= -999u - 1999v
          \end{align}
          $$
          <p>with initial conditions $u(0) = 1$ and $v(0) = 0$.</p>
        </section>

        <section>
          <h2>Stiff Problems</h2>
          <p>Solving it using RK4:</p>
          <img src="stiff2.png" alt="stiff" width="60%">
        </section>

        <section>
          <h2>Stiff Problems</h2>
          <p>Solving it using RK4:</p>
          <img src="stiff.png" alt="stiff" width="60%">
        </section>

        <section>
          <h2>Stiff Problems</h2>
          <p>The exact solution is:</p>
          $$
          \begin{align}
          u(x) &= 2e^{-x} - e^{-1000x} \\
          v(x) &= -e^{-x} + e^{-1000x}
          \end{align}
          $$
          <div class="fragment">
            <p>At the beginning of the integration, the second term rapidly drops to
              zero. If this process is not resolved correctly, then numerical
              solutions becomes completely off.</p>
            <p>Due to this rapid change at small length scales, this problem is <em>stiff</em>.</p>
          </div>
        </section>

        <section>
          <h2>Stiff Problems</h2>
          <p>Stiffness often occurs in a problem where there are two very
            different scales of $x$ where $y$ is changing.</p>
          <div class="fragment">
            <p>This occurs more often than you might think. Consider the following chemical reaction:</p>
            $$
            \begin{align}
            A &\xrightarrow{0.04} B \\
            B + B &\xrightarrow{3\times 10^7} C + B \\
            B + C &\xrightarrow{1\times 10^4} A + C
            \end{align}
            $$
          </div>
        </section>

        <section>
          <h2>Stiff Problems</h2>
          <p>The concentration of chemicals $A$, $B$, and $C$ are described by
            the following differential equations:</p>
          $$
          \begin{align}
          \frac{dA}{dt} &= -0.04A + 10^4BC \\
          \frac{dB}{dt} &= 0.04A - 3\times 10^7B^2 - 10^4BC \\
          \frac{dC}{dt} &= 3\times 10^7B^2
          \end{align}
          $$
        </section>

        <!-- <section>
             <h2>Stability</h2>
             <p>For the system of equations we looked at earlier, RK4 is <em>unstable</em> at
             $h = 3\times 10^{-3}$, but is <em>stable</em> at $h = 2\times 10^{-3}$.</p>
             How to quantify stability?
             </section>
        -->
        <section>
          <h2>Stability of a Single Equation</h2>
          <p>Consider the simple equation:</p>
          $$
          \frac{dy}{dx} = -\lambda y, \quad \lambda > 0
          $$
          <div class="fragment">
            <p>Let's apply the simple Euler method to solve it:</p>
            $$
            y_{n+1} = y_n + h(-\lambda y_n) = (1 - h\lambda)y_n
            $$
            <p class="fragment">
              How does $|y_n|$ behave as $n \to \infty$?
            </p>
          </div>
        </section>

        <section>
          <h2>Stability of a Single Equation</h2>
          <p>For our simple Euler method on the sample equation:</p>
          $$
          |y_{n+1}| = |(1 - h\lambda)y_n| = |1 - h\lambda||y_n| = |1 - h\lambda|^{n+1} |y_0|
          $$
          <p class="fragment">So, if $|1 - h\lambda| < 1$, then $|y_n| \to 0$ as $n \to \infty$. This is the correct behavior. </p>
          <p class="fragment">If $|1 - h\lambda| > 1$, then $|y_n| \to \infty$ as $n \to \infty$.
            This causes unstable behavior. The
            stability criteria is $h < 2/\lambda$.</p>
          <p class="fragment">If $\lambda$ is large, then $h$ needs to be very small!</p>
        </section>

        <section>
          <h2>Stability of Multiple Equations</h2>
          <p>We can generalize this to a set of linear equations:</p>
          $$
          \frac{d\mathbf{y}}{dx} = -\mathbf{A}\cdot\mathbf{y}
          $$
          <p>where $\mathbf{A}$ is an $n\times n$ matrix.</p>
        </section>

        <section>
          <h2>Stability of Multiple Equations</h2>
          <p>If we apply the Euler method to this system, we get:</p>
          $$
          \mathbf{y}_{n+1} = \mathbf{y}_n + h(-\mathbf{A}\cdot\mathbf{y}_n) = (1 - h\mathbf{A})\mathbf{y}_n = (1 - h\mathbf{A})^n \mathbf{y}_0
          $$
          <div class="fragment">
            <p>If $\mathbf{A}$ is diagonalizable, with eigenvalues $\{\lambda_i\}$ and eigenvectors
              $\{\boldsymbol{\xi}_i\}$, then we can expand $y_0$ in terms of the eigenvectors:</p>
            $$
            \mathbf{y}_0 = \sum_i c_i\boldsymbol{\xi}_i
            $$
            <div class="fragment">
              <p>Then, we can write:</p>
              $$
              \mathbf{y}_n = \sum_i c_i(1 - h\lambda_i)^n\boldsymbol{\xi}_i
              $$
            </div>
          </div>
        </section>

        <section>
          <h2>Stability of Multiple Equations</h2>
          <p>For stability, we need $|1 - h\lambda_i| < 1$ for all $i$. Otherwise
            one of the components may blow up. The criteria becomes:</p>
          $$
          h < \frac{2}{|\lambda_\mathrm{max}|}
          $$
          <p>A system of equations is stiff if $|\lambda_\mathrm{max} /
            \lambda_\mathrm{min}| \gg 1$.</p>
        </section>

        <section>
          <h2>Stability of Multiple Equations</h2>
          <p>The system we looked at in the beginning has the following matrix:</p>
          $$
          \mathbf{A} = \begin{pmatrix}
          998 & 1998 \\
          -999 & -1999
          \end{pmatrix}
          $$
          <div class="fragment">
            <p>Its diagonalized form is:</p>
            $$
            \mathbf{A}_\mathrm{diag} = \begin{pmatrix}
            -1000 & 0 \\
            0 & -1
            \end{pmatrix}
            $$
          </div>
        </section>

        <section>
          <h2>How to Overcome Stiffness?</h2>
          <div class="fragment">(without resorting to a tiny step size)</div>
        </section>

        <section>
          <h2>Implicit Schemes</h2>
          <p>Consider the following modification to Euler's method:</p>
          $$
          y_{n+1} = y_n + h y'_{n+1}
          $$
          <div class="fragment">
            <p>$y'_{n+1}$ is the derivative $dy/dx$ evaluated at step $n+1$. Then
              applying this to our simple equation $y' = -\lambda y$, we get:</p>
            $$
            y_{n+1} = y_n - h\lambda y_{n+1},\quad y_{n+1} = \frac{y_n}{1 +
            h\lambda} $$
            <p>Now this is absolutely stable. As long as $\lambda > 0$, you always get decreasing $|y_n|$.</p>
          </div>
        </section>

        <section>
          <h2>Implicit Schemes</h2>
          <p>The method we constructed is called the <em>implicit</em> Euler's method. How
            do we actually carry it out?</p>
          <div class="fragment">
            <p>We need to solve the following equation at every step:</p>
            $$
            y_{n+1} = y_n + h f(x_n + h, y_{n+1})
            $$
            <p class="fragment">Remember root-finding?</p>
          </div>
        </section>

        <section>
          <h2>Implicit Schemes</h2>
          <p>Implicit Euler using large time steps:</p>
          <img src="implicit_euler.png" alt="implicit_euler" width="60%">
        </section>

        <section>
          <h2>Implicit Schemes</h2>
          <p>A way to avoid solving a nonlinear equation at every step is to linearize it:</p>
          $$
          y_{n+1} = y_n + h\left[ f(y_n) + \left.\frac{df}{dy}\right|_{y_n}(y_{n+1} - y_n)\right]
          $$
          <div class="fragment">
            <p>Rearranging terms, we get:</p>
            $$
            y_{n+1} = y_n + h\left(1 - h\frac{df}{dy}\right)^{-1} f(y_n)
            $$
            <p>This is called the <em>semi-implicit Euler's method</em>.</p>
          </div>
        </section>

        <section>
          <h2>Implicit Schemes</h2>
          <p>Semi-implicit methods are typically much more stable than explicit
            schemes, but it's not guaranteed. To guarantee stability, one needs to
            solve the nonlinear equation for $y_{n+1}$ at every step to a target
            tolerance.</p>
          <div class="fragment">
            <p>In the case of multiple-equation systems, the equation for
              $\mathbf{y}_{n+1}$ is a nonlinear multi-variable equation:</p>
            $$
            \mathbf{y}_{n+1} = \mathbf{y}_n + h \mathbf{f}(\mathbf{y}_{n+1})
            $$
          </div>
          <p class="fragment">We will cover how to solve this type of equations
            in the later parts of this course.</p>
        </section>


          </div>
      </div>
      <!-- <script src="js/head.min.js"></script> -->
      <!-- <script>
           head.js(
           "vendor/jquery.min.js",
           // "vendor/three.js/build/three.min.js",
           // "vendor/three.js/examples/js/controls/OrbitControls.js",
           /* "vendor/socket.io-client/dist/socket.io.js", */
           // "vendor/THREE.MeshLine.js",
           /* "vendor/dat.gui.min.js",*/
           "vendor/EventEmitter.js",
           // "js/samples.js",
           );
           </script> -->
      <script src="../dist/reveal.js"></script>
      <script src="../plugin/math/math.js"></script>
      <script src="../plugin/notes/notes.js"></script>
      <script src="../plugin/markdown/markdown.js"></script>
      <script src="../plugin/highlight/highlight.js"></script>

      <script>
        // More info about initialization & config:
        // - https://revealjs.com/initialization/
        // - https://revealjs.com/config/
        Reveal.initialize({
          transition: "fade",
          slideNumber: true,
          history: true,
          center: true,
          width: "100%",
          height: "100%",
          disableLayout: false,
          navigationMode: "default",
          // minScale: 1,
          // maxScale: 1,
          margin: 0.2,
          padding: 0,
          hash: true,
          math: {
            mathjax: 'https://cdn.jsdelivr.net/gh/mathjax/mathjax@2.7.8/MathJax.js',
            config: 'TeX-AMS_HTML-full',
            // pass other options into `MathJax.Hub.Config()`
            TeX: { Macros: { RR: "{\\bf R}" } }
          },
          // Learn about plugins: https://revealjs.com/plugins/
          plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealMath ]
        });
        Reveal.configure({
          keyboard: {
            81: null, // Do not respond to Q
            // 32: null, // Do not respond to space
          }
        });
        // Reveal.addEventListener("slidechanged", function(event) {
        //   var foot1 = document.getElementById("footer1");
        //   var foot2 = document.getElementById("footer2");
        //
        //   if (Reveal.getIndices().h === 0) {
        //     foot1.style.display = "none";
        //     foot2.style.display = "none";
        //   } else {
        //     foot1.style.display = "block";
        //     foot2.style.display = "block";
        //   }
        // });
        //
      </script>
  </body>
</html>
